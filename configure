#! /bin/sh

show_help()
{
  echo "
Usage: ./configure [OPTIONS]

OPTIONS:

  -h, --help         display this help and exit
      --config-NAME  select the configuration file which should be used
                     i.e. '--config-x86-linux-gcc' will generate a
                     makefile based on 'config_x86-linux-gcc.sh'
                     default [--config-default]
  "
  
  # http://www.gnu.org/prep/standards/html_node/Configuration.html
  # http://www.sourceware.org/autobook/autobook/autobook_17.html#SEC17
  # http://www.gnu.org/software/automake/manual/html_node/Cross_002dCompilation.html
  #

  # --prefix --exec-prefix --bindir --sbindir --libexecdir --sysconfdir
  # --sharedstatedir --localstatedir --libdir --includedir --oldincludedir
  # --datarootdir --datadir --infodir --localedir --mandir --docdir
  # --htmldir --dvidir --pdfdir --psdir
  #
  # cpu-company-system
  # cpu-manufacter-os-kernel
  # i.e. i686-pc-linux-gnu, i386-linux-gnu, rs6000-ibm-aix3.2, i386-pc-winnt4.0, sparc-sun-solaris2.4, i586-mingw32msvc
  #
  # ‘--enable-feature[=parameter]’
  # ‘--with-package’
  # ‘variable=value’ i.e. ./configure CC=gcc, CC=gcc ./configure
  #
  # cross compile
  # /configure --host=hosttype --target=targettype
  #
  # --build=build-type
  #       the type of system on which the package is being configured and compiled. It defaults to the result of running config.guess. Specifying a build-type that differs from host-type enables cross-compilation mode.
  # --host=host-type
  #       the type of system on which the package runs. By default it is the same as the build machine. Specifying a host-type that differs from build-type, when build-type was also explicitly specified, enables cross-compilation mode.
  # --target=target-type
  #       the type of system for which any compiler tools in the package produce code (rarely needed). By default, it is the same as host. 

  exit
}

check_command()
{
	$@ >/dev/null 2>&1
	if [ $? = 0 ]
	then
		echo "$AF_GREEN ok $AF_RESET"
	else
		echo "$AF_RED failed $AF_RESET"
		return 1
	fi
}

check_env()
{
	tput -V >/dev/null 2>&1
	if [ $? = 0 ]
	then
		AF_RED=$(tput setaf 1)
		AF_GREEN=$(tput setaf 2)
		AF_YELLOW=$(tput setaf 3)
		AF_RESET=$(tput sgr0)
	fi

	#echo -n "  checking ls ... "
	#check_command "ls --version"

	#echo -n "  checking cp ... "
	#check_command "cp --version"

	#echo -n "  checking rm ... "
	#check_command "rm --version"

	#echo -n "  checking mkdir ... "
	#check_command "mkdir --version"

	#echo -n "  checking rmdir ... "
	#check_command "rmdir --version"

	#echo -n "  checking tar ... "
	#check_command "tar --version"

	#echo -n "  checking chmod ... "
	#check_command "chmod --version"

	#echo -n "  checking wc ... "
	#check_command "wc --version"

	echo -n "  checking find ... "
	check_command "find --version"

	echo -n "  checking du ... "
	check_command "du --version"

	echo -n "  checking grep ... "
	check_command "grep --version"

	echo -n "  checking sed ... "
	check_command "sed --version"

	echo -n "  checking printf ... "
	check_command "printf '%s' 'x'"

	echo -n "  checking sort ... "
	check_command "sort --version"

	echo -n "  checking uniq ... "
	check_command "uniq --version"

	#echo -n "  checking uname ... "
	#check_command "uname --version"

	echo -n "  checking make ... "
	check_command "make --version"

	echo -n "  checking gcc ... "
	check_command "gcc --version"

	echo -n "  checking ld ... "
	check_command "ld --version"

	#echo -n "  checking dpkg-deb ... "
	#check_command "dpkg-deb --version"

	#echo -n "  checking update-menus ... "
	#check_command "update-menus --version"

	#echo -n "  checking  update-mime ... "
	#check_command "update-mime --version"
}

default_config()
{
	PKGNAME="no-name"
	PKGVERSION="1.0"
	PKGSECTION="none"
	PKGAUTHOR="nobody <nobody@nowhere>"
	PKGHOMEAGE="http://"
	PKGDEPENDS=""
	PKGDESCRIPTION="Title
Description"
	SRCPATTERN="*.c *.cc *.c++ *.cxx *.cpp"
	SRCDIR="src"
	OBJDIR="obj"
	DISTROOT=""
	BINFILE="bin/no-name"
	CC="gcc"
	CFLAGS="-c -Wall -O2"
	LD="gcc"
	LDFLAGS="-s"
}

load_config()
{
	echo -n "  checking file access ... "
	if [ -f $CONFIGSCRIPT ]
	then
		echo "$AF_GREEN ok $AF_RESET"
		. $CONFIGSCRIPT
	else
		echo "$AF_RED failed $AF_RESET"
		return 1
	fi

	echo -n "  checking source directory ($SRCDIR) ... "
	if [ -d "$SRCDIR" ]
	then
		echo "$AF_GREEN ok $AF_RESET"
		echo -n "  checking source files ($SRCPATTERN) ... "
		if [ $(find $SRCDIR -type f -name $(echo $SRCPATTERN | sed -e "s| | -or -name |g") | wc -l) != 0 ]
		then
			echo "$AF_GREEN ok $AF_RESET"
		else
			echo "$AF_RED none found $AF_RESET"
			return 1
		fi
	else
		#mkdir -p "$SRCDIR"
		#if [ -d "$SRCDIR" ]
		#then
		#	
		#else
			echo "$AF_RED invalid directory $AF_RESET"
			return 1
		#fi
	fi

	echo -n "  checking object directory ($OBJDIR) ... "
	if [ -d "$OBJDIR" ]
	then
		echo "$AF_GREEN ok $AF_RESET"
	else
		mkdir -p "$OBJDIR"
		if [ -d "$OBJDIR" ]
		then
			echo "$AF_YELLOW not found $AF_RESET -> $AF_GREEN created $AF_RESET"
		else
			echo "$AF_RED invalid directory $AF_RESET"
			return 1
		fi
	fi

	BINPATH=$(echo $BINFILE | sed -e 's|/[^/]*$||g')
	echo -n "  checking binary file path ($BINPATH) ... "
	if [ -d "$BINPATH" ]
	then
		echo "$AF_GREEN ok $AF_RESET"
	else
		mkdir -p "$BINPATH"
		if [ -d "$BINPATH" ]
		then
			echo "$AF_YELLOW not found $AF_RESET -> $AF_GREEN created $AF_RESET"
		else
			echo "$AF_RED invalid path $AF_RESET"
			return 1
		fi
	fi

	echo -n "  checking distribution root ($DISTROOT) ... "
	if [ -d "$DISTROOT" ]
	then
		echo "$AF_GREEN ok $AF_RESET"
		echo -n "  checking distribution content ($DISTROOT/*) ... "
		if [ $(ls $DISTROOT | wc -l) != 0 ]
		then
			echo "$AF_GREEN ok $AF_RESET"
		else
			echo "$AF_YELLOW none found $AF_RESET -> $AF_GREEN ignored $AF_RESET"
			DISTROOT=""
		fi
	else
		#mkdir -p "$DISTROOT"
		#if [ -d "$DISTROOT" ]
		#then
		#	echo "$AF_YELLOW not found $AF_RESET -> $AF_GREEN created $AF_RESET"
		#else
			echo "$AF_YELLOW invalid directory $AF_RESET -> $AF_GREEN ignored $AF_RESET"
			DISTROOT=""
		#fi
	fi

	echo -n "  checking compiler ($CC) ... "
	check_command "$CC -v"

	echo -n "  checking includes (-I) ... "
	check_command "ls $(echo '$CFLAGS' | grep -o '\-I\S*' | sed -e 's|-I||g')"

	echo -n "  checking linker ($LD) ... "
	check_command "$LD -v"

	echo -n "  checking libraries (-L, -l, /*) ... "
	check_command "ld -lc $(echo '$LDFLAGS' | grep -o '\s\/\S*\|[\-][Ll]\S*') -o /dev/null"
}

write_makefile_header()
{
	echo "# Makefile generated by makebreed" >> $MAKEFILE
	echo "# http://makebreed.googlecode.com" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "# Creation Time: '$(date)'" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

write_makefile_configuration()
{
	echo "PKGNAME = $PKGNAME" >> $MAKEFILE
	echo "PKGVERSION = $PKGVERSION" >> $MAKEFILE
	echo "PKGSECTION = $PKGSECTION" >> $MAKEFILE
	echo "PKGAUTHOR = $PKGAUTHOR" >> $MAKEFILE
	echo "PKGHOMEAGE = $PKGHOMEAGE" >> $MAKEFILE
	echo "PKGDEPENDS = $(echo $PKGDEPENDS | sed -e 's|([^)]*)||g;s|,||g;s|  | |g')" >> $MAKEFILE
	echo "PKGDESCRIPTION = $PKGDESCRIPTION" | sed 's|$|\\n\\|'>> $MAKEFILE
	echo " ." >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "SRCPATTERN = $SRCPATTERN" >> $MAKEFILE
	echo "SRCDIR = $SRCDIR" >> $MAKEFILE
	echo "OBJDIR = $OBJDIR" >> $MAKEFILE

	if [ "$DISTROOT" ]
	then
		echo "DISTROOT = $DISTROOT" >> $MAKEFILE
	else
		echo "DISTROOT = /dev/null" >> $MAKEFILE
	fi

	echo "BINFILE = $BINFILE" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "CC = $CC" >> $MAKEFILE
	echo "CFLAGS = $(echo $CFLAGS | sed -e 's|[ ]+| |g')" >> $MAKEFILE
	echo "LD = $LD" >> $MAKEFILE
	echo "LDFLAGS = $(echo $LDFLAGS | sed -e 's|[ ]+| |g')" >> $MAKEFILE
	echo "LDLIBS = $(echo $LDLIBS | sed -e 's|[ ]+| |g')" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "SRCFILES := \$(shell find \$(SRCDIR) -type f -name '' \$(addprefix -or -name , \$(SRCPATTERN)))" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "OBJFILES := \$(patsubst \$(SRCDIR)/%, \$(OBJDIR)/%.o, \$(SRCFILES))" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "DISTFILES := \$(patsubst \$(DISTROOT)%, %, \$(shell find \$(DISTROOT) -type f))" >> $MAKEFILE
	echo "DISTDIRECTORIES := \$(patsubst \$(DISTROOT)%, %, \$(shell find \$(DISTROOT) -type d -empty))" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "TGZPKG := \$(PKGNAME)_\$(PKGVERSION).tar.gz" >> $MAKEFILE
	echo "DEBPKG := \$(PKGNAME)_\$(PKGVERSION)_\$(shell dpkg --print-architecture).deb" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

write_makefile_rule_build()
{
	echo "all: \$(BINFILE)" >> $MAKEFILE
	echo "		" >> $MAKEFILE
	echo "\$(BINFILE): \$(OBJFILES)" >> $MAKEFILE
	echo "		@echo " >> $MAKEFILE
	echo "		@\$(shell mkdir -p \$(dir \$@))" >> $MAKEFILE
	echo "		\$(LD) \$(LDFLAGS) -o \$@ \$^ \$(LDLIBS)" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "\$(CURDIR)/\$(OBJDIR)/%.o \$(CURDIR)/\$(SRCDIR)/%.o \$(SRCDIR)/%.o: \$(OBJDIR)/%.o" >> $MAKEFILE
	echo "		" >> $MAKEFILE
	echo "\$(OBJDIR)/%.o: \$(SRCDIR)/%" >> $MAKEFILE
	echo "		@echo " >> $MAKEFILE
	echo "		@\$(shell mkdir -p \$(dir \$@))" >> $MAKEFILE
	echo "		\$(CC) \$(CFLAGS) -o \$@ \$<" >> $MAKEFILE
	echo "		@gcc \$(CFLAGS) -MM -MT \$@ \$< >> \$(OBJDIR)/\$*.depend" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "-include \$(OBJFILES:.o=.depend)" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

write_makefile_rule_clean()
{
	echo "clean:" >> $MAKEFILE
	#echo "		@find \$(OBJDIR) -type f -delete" >> $MAKEFILE
	#echo "		@rm -f \$(BINFILE)" >> $MAKEFILE
	echo "		@rm -f \$(OBJFILES) \$(OBJFILES:.o=.depend) \$(BINFILE)" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

write_makefile_rule_dist_installer()
{
	echo "install:" >> $MAKEFILE
	echo "		@cp -v -r \$(DISTROOT)/* /" >> $MAKEFILE
	echo "		@update-menus" >> $MAKEFILE
	echo "" >> $MAKEFILE
	echo "uninstall:" >> $MAKEFILE
	echo "		@rm -v -f \$(DISTFILES) 2> /dev/null" >> $MAKEFILE
	echo "		@rmdir -p --ignore-fail-on-non-empty \$(DISTDIRECTORIES) 2> /dev/null" >> $MAKEFILE
	echo "		@rmdir -p --ignore-fail-on-non-empty \$(dir \$(DISTFILES)) 2> /dev/null" >> $MAKEFILE
	echo "		@update-menus" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

write_makefile_rule_dist_tgz()
{
	echo "tgz:" >> $MAKEFILE
	echo "		@tar -v -c -z --exclude='\$(TGZPKG)' --exclude='make*' --exclude='*.deb' --exclude='\$(BINFILE)' --exclude='\$(OBJDIR)/*' -f \$(TGZPKG) *" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

write_makefile_rule_dist_deb()
{
	echo "deb: all" >> $MAKEFILE
	echo "		@mkdir -p \$(DISTROOT)/DEBIAN 2> /dev/null" >> $MAKEFILE
	echo "		@echo 'Package: $PKGNAME' > \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Version: $PKGVERSION' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Section: $PKGSECTION' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Architecture: $(dpkg --print-architecture)' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Installed-Size: \$(shell du -k -c $DISTROOT | grep 'total' | sed -e 's|\s*total||g')' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Depends: \$(RESOLVE_PKG_DEPS)' | sed -e 's|,\$\$||g' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Maintainer: $PKGAUTHOR' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Priority: extra' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Homepage: $PKGHOMEAGE' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo 'Description: \$(PKGDESCRIPTION)' >> \$(DISTROOT)/DEBIAN/control" >> $MAKEFILE
	echo "		@echo '#! /bin/sh' > \$(DISTROOT)/DEBIAN/postinst" >> $MAKEFILE
	echo "		@echo '' >> \$(DISTROOT)/DEBIAN/postinst" >> $MAKEFILE
	echo "		@echo 'update-menus' >> \$(DISTROOT)/DEBIAN/postinst" >> $MAKEFILE
	echo "		@echo 'update-mime' >> \$(DISTROOT)/DEBIAN/postinst" >> $MAKEFILE
	echo "		@chmod 0755 \$(DISTROOT)/DEBIAN/postinst" >> $MAKEFILE
	echo "		@echo '#! /bin/sh' > \$(DISTROOT)/DEBIAN/postrm" >> $MAKEFILE
	echo "		@echo '' >> \$(DISTROOT)/DEBIAN/postrm" >> $MAKEFILE
	echo "		@echo 'update-menus' >> \$(DISTROOT)/DEBIAN/postrm" >> $MAKEFILE
	echo "		@echo 'update-mime' >> \$(DISTROOT)/DEBIAN/postrm" >> $MAKEFILE
	echo "		@chmod 0755 \$(DISTROOT)/DEBIAN/postrm" >> $MAKEFILE
	echo "		@rm -f \$(DEBPKG)" >> $MAKEFILE
	echo "		@dpkg-deb -v -b \$(DISTROOT) \$(DEBPKG)" >> $MAKEFILE
	echo "		@rm -f -r \$(DISTROOT)/DEBIAN" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

write_makefile_dependency_resolver()
{
	echo "# BEGIN: deb package dependency resolving block" >> $MAKEFILE
	echo "# {" >> $MAKEFILE
	echo "    # non-escape patterns" >> $MAKEFILE
	echo "    PATTERN_01 = s|^Depends: ||g;s|([^)]*)||g;s|,||g;s|  | |g" >> $MAKEFILE
	echo "    PATTERN_02 = ," >> $MAKEFILE
	echo "    PATTERN_03 = (" >> $MAKEFILE
	echo "    PATTERN_04 = )" >> $MAKEFILE
	echo "    PATTERN_05 = (%)" >> $MAKEFILE
	echo "    PATTERN_06 = =" >> $MAKEFILE
	echo "    PATTERN_07 = (>=" >> $MAKEFILE
	echo "    # generate a list of required packages for the binary file" >> $MAKEFILE
	echo "    BIN_PKG_DEPS = \$(sort \$(shell dpkg -S \$(filter /%, \$(shell ldd \$(BINFILE) 2> /dev/null)) 2> /dev/null | sed -e 's|:.*||g'))" >> $MAKEFILE
	echo "    # generate a list of user defined packages for the binary file" >> $MAKEFILE
	echo "    USER_PKG_DEPS = \$(PKGDEPENDS)" >> $MAKEFILE
	echo "    # add user defined packages to required packages" >> $MAKEFILE
	echo "    BIN_USER_PKG_DEPS = \$(sort \$(BIN_PKG_DEPS) \$(USER_PKG_DEPS))" >> $MAKEFILE
	echo "    # generate a list of all dependencies for each required package (ignore user defined packages)" >> $MAKEFILE
	echo "    RECURSIVE_PKG_DEPS = \$(sort \$(shell dpkg -s \$(BIN_PKG_DEPS) 2> /dev/null | grep '^Depends:' | sed -e \"\$(PATTERN_01)\"))" >> $MAKEFILE
	echo "    # remove packages which are already included by other packages (recursive dependencies)" >> $MAKEFILE
	echo "    DISTINCT_PKG_DEPS = \$(filter-out \$(RECURSIVE_PKG_DEPS),\$(BIN_USER_PKG_DEPS))" >> $MAKEFILE
	echo "    # append version information for each package available on the system" >> $MAKEFILE
	echo "    GET_PKG_VERSION = \$(shell dpkg -s \$(PACKAGE) 2> /dev/null | grep '^Version:' | sed -e 's|Version: ||g')" >> $MAKEFILE
	echo "    RESOLVE_PKG_DEPS = \$(foreach PACKAGE,\$(DISTINCT_PKG_DEPS),\$(if \$(GET_PKG_VERSION),\$(PACKAGE) \$(PATTERN_07)\$(GET_PKG_VERSION)\$(PATTERN_04),\$(PACKAGE))\$(PATTERN_02))" >> $MAKEFILE
	echo "# }" >> $MAKEFILE
	echo "# END" >> $MAKEFILE
	echo "" >> $MAKEFILE
}

######################################
### main entry point of the script ###
######################################

CONFIGSCRIPT=$(pwd)/config_default.sh
MAKEFILE=$(pwd)/Makefile

# itereate commandline arguments
for ARG in "$@"
do
	case "$ARG" in
		-h)				show_help
						;;
		--help)			show_help
						;;
		--config-*)		CONFIGSCRIPT=$(pwd)/config_$(echo $ARG | sed -e 's|--config-||g').sh
						;;
	esac
done

rm -f $MAKEFILE

echo 
echo "Environment:"
check_env
if [ $? = 0 ]
then
	echo 
	echo "Using: $(basename $CONFIGSCRIPT)"
	default_config
	load_config
	if [ $? = 0 ]
	then
		write_makefile_header
		write_makefile_configuration
		write_makefile_rule_build
		write_makefile_rule_clean
		write_makefile_rule_dist_installer
		write_makefile_rule_dist_tgz
		write_makefile_rule_dist_deb
		write_makefile_dependency_resolver
	fi
fi

echo 
